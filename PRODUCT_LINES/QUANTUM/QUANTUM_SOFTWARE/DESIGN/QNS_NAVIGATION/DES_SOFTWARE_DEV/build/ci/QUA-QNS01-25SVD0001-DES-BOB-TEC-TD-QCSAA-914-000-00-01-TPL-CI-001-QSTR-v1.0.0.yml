# GitLab CI/CD Pipeline Configuration
stages:
  - build
  - test
  - quantum-validation
  - security-scan
  - package
  - deploy

variables:
  GIT_DEPTH: 10
  BUILD_DIR: "build"
  ARTIFACT_NAME: "AQUA_V_QNS"

before_script:
  - apt-get update -qq
  - apt-get install -y cmake g++ libeigen3-dev qt6-base-dev libgtest-dev

build:debug:
  stage: build
  script:
    - mkdir -p ${BUILD_DIR}
    - cd ${BUILD_DIR}
    - cmake .. -DCMAKE_BUILD_TYPE=Debug
    - make -j$(nproc)
  artifacts:
    paths:
      - ${BUILD_DIR}/
    expire_in: 1 day

build:release:
  stage: build
  script:
    - mkdir -p ${BUILD_DIR}
    - cd ${BUILD_DIR}
    - cmake .. -DCMAKE_BUILD_TYPE=Release
    - make -j$(nproc)
  artifacts:
    paths:
      - ${BUILD_DIR}/
    expire_in: 1 week

test:unit:
  stage: test
  dependencies:
    - build:debug
  script:
    - cd ${BUILD_DIR}
    - ./tests/unit_tests --gtest_output=xml:unit_test_results.xml
  artifacts:
    reports:
      junit: ${BUILD_DIR}/unit_test_results.xml

test:integration:
  stage: test
  dependencies:
    - build:debug
  script:
    - cd ${BUILD_DIR}
    - ./tests/integration_tests --gtest_output=xml:integration_test_results.xml
  artifacts:
    reports:
      junit: ${BUILD_DIR}/integration_test_results.xml

quantum:validation:
  stage: quantum-validation
  dependencies:
    - build:release
  script:
    - cd ${BUILD_DIR}
    - ./tools/quantum_validator
  allow_failure: false

security:scan:
  stage: security-scan
  script:
    - cppcheck --enable=all --xml --xml-version=2 src/ 2> cppcheck.xml
  artifacts:
    reports:
      codequality: cppcheck.xml

package:deb:
  stage: package
  dependencies:
    - build:release
  script:
    - cd ${BUILD_DIR}
    - cpack -G DEB
  artifacts:
    paths:
      - ${BUILD_DIR}/*.deb
    expire_in: 1 month

deploy:staging:
  stage: deploy
  dependencies:
    - package:deb
  script:
    - echo "Deploying to staging environment"
  environment:
    name: staging
  only:
    - develop

deploy:production:
  stage: deploy
  dependencies:
    - package:deb
  script:
    - echo "Deploying to production"
  environment:
    name: production
  only:
    - main
  when: manual
